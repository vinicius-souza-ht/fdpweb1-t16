<!DOCTYPE>
<html>
<head>
<meta charset="UTF-8">
<title>CRUD Usuário</title>


</head>

<body>
	<form action="javascript:void(0)" onsubmit="app.salvar()">

		<input type="text" id="add-nome" placeholder="Nome"> 
		<input type="text" id="add-email" placeholder="Email">
		<input type="submit" value="Salvar"> 
		<input type="button" value="Cancelar" onclick="app.novo()">

	</form>

	<p id="contador"></p>

	<table border="1">
		<tr></tr>

		<tbody id="usuarios">

		</tbody>
	</table>

</body>

<script>
	var app = new function() {

		this.elUsuarios = document.getElementById("usuarios");
		this.usuarios = [];
		this.itemEditar = -1;

		this.contar = function(qtd) {
			var elContador = document.getElementById("contador");
			var nome = "Usuario";
			if (qtd) {
				if (qtd > 1) {
					nome = "Usuários";
				}
				elContador.innerHTML = qtd + ' ' + nome;

			} else {
				elContador.innerHTML = 'Sem ' + nome;
			}
		};

		this.salvar = function() {

			var elNome = document.getElementById("add-nome");
			var elEmail = document.getElementById("add-email");
			
			var usuario =  {nome:elNome.value,email:elEmail.value};
			
			if (usuario) {
				if (this.itemEditar == -1) {

					var xhttp = new XMLHttpRequest();

					//CallBack
					xhttp.onreadystatechange = function() {
						//processou com sucesso
						if (this.readyState == 4 && this.status == 200) {
							//inserindo no vetor
							//app.usuarios.push(usuario);
							app.listarTodos();
							app.novo();
						}
					}

					//Faz o request
					xhttp.open("POST", "usucontroller", true);
					//Formato dos dados para envio
					xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
					xhttp.send("nome="+usuario.nome+"&email="+usuario.email);

				} else {

					var xhttp = new XMLHttpRequest();

					//callback
					xhttp.onreadystatechange = function() {
						//processou com sucesso
						if (this.readyState == 4 && this.status == 200) {
							//Altera quando tem alguem para alterar
							//app.usuarios.splice(app.itemEditar, 1, usuario);
							app.listarTodos();
						}
					};
					
					params ="i="+this.itemEditar+"&nome="+usuario.nome+"&email="+usuario.email;

					
					//Faz o request
					xhttp.open("PUT", "usucontroller?" + params, true);
					//Formato dos dados para envio
					xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					xhttp.send();
					
					this.itemEditar = -1;
				}
				
				this.novo();

			}

			this.listarTodos();
			this.novo();
		}

		this.excluir = function(item) {
			//this.usuarios.splice(item, 1);
			this.listarTodos();
		}

		this.editar = function(item) {
			this.itemEditar = item;
			var nome = this.usuarios[item];

			if (nome) {
				document.getElementById("add-nome").value = nome;
			}
		}

		this.listarTodos = function() {
			var xhttp = new XMLHttpRequest();
			
			//callback
            xhttp.onreadystatechange = function() {
                //processou com sucesso
                if (this.readyState == 4 && this.status == 200) {
                        //inserindo no vetor
                        //JSON.parse(ajaxResponse);
                        app.usuarios = eval(this.responseText);
                }
            };
            
            //Faz o request
            xhttp.open("GET", "usucontroller", true);
            xhttp.send(); 

          //gera String em formato tabela
          var dados = '';
          
          for (i = 0; i < this.usuarios.length; i++){
        	  dados+='<tr>';
              dados+='<td>'+this.usuarios[i].nome+'</td>';
              dados+='<td>'+this.usuarios[i].email+'</td>';
              dados+='<td><button onclick="app.excluir('+i+')">excluir</button></td>';
              dados+='<td><button onclick="app.editar('+i+')">editar</button></td>';
            
              dados+="</tr>";
          }
        //atualiza contador
          this.contar(this.usuarios.length);
          //atualizar DOM
          this.elUsuarios.innerHTML= dados;
		}

		this.novo = function() {
			this.itemEditar = -1;
			document.getElementById("add-nome").value = "";
		}

	}

	app.listarTodos();
</script>
</html>